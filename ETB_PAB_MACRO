WITH Safe_Source AS (
    SELECT
        CAST(ISNULL(p.ITEMNMBR, '') AS VARCHAR(50)) AS ITEMNMBR,
        CAST(ISNULL(p.ORDERNUMBER, '') AS VARCHAR(50)) AS ORDERNUMBER,
        CAST(ISNULL(p.MRPTYPE, '') AS VARCHAR(10)) AS MRPTYPE,
        CAST(ISNULL(p.STSDESCR, '') AS VARCHAR(100)) AS STSDESCR,
        CAST(ISNULL(p.DUEDATE, '') AS VARCHAR(50)) AS DUEDATE,
        CAST(ISNULL(p.[Date + Expiry], '') AS VARCHAR(50)) AS DatePlusExpiry,
        TRY_CAST(p.Deductions AS DECIMAL(18,6)) AS Deductions_Num,
        TRY_CAST(p.Expiry AS DECIMAL(18,6)) AS Expiry_Num,
        TRY_CAST(p.[PO's] AS DECIMAL(18,6)) AS POs_Num
    FROM dbo.ETB_PAB p
),

ItemBegBal AS (
    SELECT 
        ITEMNMBR,
        MAX(COALESCE(TRY_CAST(BEG_BAL AS DECIMAL(18,6)), 0)) AS Starting_Balance
    FROM dbo.ETB_PAB
    GROUP BY ITEMNMBR
),

Safe_PAB_AUTO AS (
    SELECT
        UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ISNULL(ORDERNUMBER, ''), 'MO', ''), '-', ''), ' ', ''), '/', ''), '.', '')) AS CleanOrder,
        CAST(ISNULL(Construct, '') AS VARCHAR(100)) AS Construct,
        CAST(ISNULL(FG, '') AS VARCHAR(50)) AS FG,
        CAST(ISNULL([FG Desc], '') AS VARCHAR(200)) AS FG_Desc,
        CAST(ISNULL(ItemDescription, '') AS VARCHAR(500)) AS ItemDescription,
        CAST(ISNULL(UOMSCHDL, '') AS VARCHAR(50)) AS UOMSCHDL,
        CAST(ISNULL(VendorItem, '') AS VARCHAR(50)) AS VendorItem,
        CAST(ISNULL(PRIME_VNDR, '') AS VARCHAR(50)) AS PRIME_VNDR
    FROM dbo.ETB_PAB_AUTO
),

Safe_Demand AS (
    SELECT 
        s.ITEMNMBR, s.ORDERNUMBER, s.MRPTYPE, s.STSDESCR, s.DUEDATE,
        s.Deductions_Num, s.Expiry_Num, s.POs_Num, s.DatePlusExpiry,
        UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ISNULL(s.ORDERNUMBER, ''), 'MO', ''), '-', ''), ' ', ''), '/', ''), '.', '')) AS CleanOrder
    FROM Safe_Source s
    WHERE s.MRPTYPE = '6'
      AND CAST(s.STSDESCR AS VARCHAR(100)) <> 'Partially Received'
      AND CAST(s.ITEMNMBR AS VARCHAR(50)) NOT LIKE '60.%'
      AND CAST(s.ITEMNMBR AS VARCHAR(50)) NOT LIKE '70.%'
),

Safe_Supply AS (
    SELECT 
        s.ITEMNMBR, s.ORDERNUMBER, s.MRPTYPE, s.STSDESCR, s.DUEDATE,
        s.Deductions_Num, s.Expiry_Num, s.POs_Num, s.DatePlusExpiry,
        UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ISNULL(s.ORDERNUMBER, ''), 'MO', ''), '-', ''), ' ', ''), '/', ''), '.', '')) AS CleanOrder
    FROM Safe_Source s
    WHERE s.MRPTYPE IN ('1', '2', '3', '4', '5', '7', '11')
),

EventStream AS (
    SELECT
        s.ITEMNMBR,
        s.ORDERNUMBER,
        s.MRPTYPE,
        s.STSDESCR,
        s.DUEDATE,
        s.DatePlusExpiry,
        s.Deductions_Num,
        s.Expiry_Num,
        s.POs_Num,
        s.CleanOrder,
        a.Construct,
        a.FG,
        a.FG_Desc,
        a.ItemDescription,
        a.UOMSCHDL,
        a.VendorItem,
        a.PRIME_VNDR
    FROM (SELECT * FROM Safe_Supply UNION ALL SELECT * FROM Safe_Demand) AS s
    LEFT JOIN Safe_PAB_AUTO a ON s.CleanOrder = a.CleanOrder
),

WithBegBal AS (
    SELECT
        e.*,
        COALESCE(ib.Starting_Balance, 0) AS Starting_Balance
    FROM EventStream e
    LEFT JOIN ItemBegBal ib ON e.ITEMNMBR = ib.ITEMNMBR
),

Enhanced AS (
    SELECT
        *,
        TRY_CAST(DUEDATE AS DATE) AS DueDate_Date,
        TRY_CAST(DatePlusExpiry AS DATE) AS DatePlusExpiry_Date,
        COALESCE(Deductions_Num, 0) AS Deductions_C,
        COALESCE(Expiry_Num, 0) AS Expiry_C,
        COALESCE(POs_Num, 0) AS POs_C
    FROM WithBegBal
),

WithDeltaAndOrder AS (
    SELECT
        *,
        POs_C - Deductions_C - Expiry_C AS Delta_Qty,
        ROW_NUMBER() OVER (PARTITION BY ITEMNMBR 
                           ORDER BY DueDate_Date ASC, DatePlusExpiry_Date ASC, ORDERNUMBER ASC) AS RowNum_PerItem
    FROM Enhanced
),

FinalCalc AS (
    SELECT
        *,
        Starting_Balance + SUM(Delta_Qty) OVER (
            PARTITION BY ITEMNMBR 
            ORDER BY DueDate_Date ASC, DatePlusExpiry_Date ASC, ORDERNUMBER ASC
            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
        ) AS Calc_Running_Balance
    FROM WithDeltaAndOrder
)

SELECT
    ITEMNMBR,
    ORDERNUMBER,
    MRPTYPE,
    STSDESCR,
    DUEDATE,
    DatePlusExpiry,
    CASE WHEN RowNum_PerItem = 1 THEN CAST(Starting_Balance AS VARCHAR(50)) ELSE '' END AS BEG_BAL,
    CAST(Deductions_C AS VARCHAR(50)) AS Deductions,
    CAST(Expiry_C AS VARCHAR(50)) AS Expiry,
    CAST(POs_C AS VARCHAR(50)) AS POs,
    CAST(Calc_Running_Balance AS VARCHAR(50)) AS Running_Balance,
    Construct,
    FG,
    FG_Desc,
    ItemDescription,
    UOMSCHDL,
    VendorItem,
    PRIME_VNDR,
    CleanOrder
FROM FinalCalc
ORDER BY 
    ITEMNMBR, 
    DueDate_Date, 
    DatePlusExpiry_Date, 
    ORDERNUMBER;
