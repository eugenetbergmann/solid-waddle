SELECT        TOP 100 PERCENT Final.ORDERNUMBER, Final.Construct, Final.FG, Final.[FG Desc], Final.ITEMNMBR, Final.ItemDescription, Final.UOMSCHDL, Final.STSDESCR, Final.DUEDATE, Final.[Expiry Dates], Final.[Date + Expiry], 
                         Final.MRPTYPE, Final.BEG_BAL_Num AS BEG_BAL, Final.Original_Deductions AS Deductions, Final.Original_Expiry AS Expiry, Final.Original_POs AS [PO's], Final.Original_Running_Balance AS Running_Balance, 
                         Final.VendorItem, Final.INCLUDE_MRP, Final.SITE, Final.PRIME_VNDR, Final.PURCHASING_LT, Final.PLANNING_LT, Final.ORDER_POINT_QTY, Final.SAFETY_STOCK, Final.MRP_IssueDate, Final.WCID_From_MO, 
                         Final.Issued, Final.Remaining, Final.Has_Issued, Final.IssueDate_Mismatch, Final.Early_Issue_Flag
FROM            (SELECT        Core.*, ISNULL(ml.MRP_IssueDate, '') AS MRP_IssueDate, ISNULL(ml.WCID_I, '') AS WCID_From_MO, ISNULL(ml.Total_Issued, 0) AS Issued, ISNULL(ml.Remaining_Required, 0) AS Remaining, 
                                                    CASE WHEN ISNULL(ml.Total_Issued, 0) > 0 THEN 'YES' ELSE 'NO' END AS Has_Issued, CASE WHEN ml.MRP_IssueDate IS NULL OR
                                                    Core.[Date + Expiry] IS NULL THEN 'NO' WHEN ml.MRP_IssueDate <> Core.[Date + Expiry] THEN 'YES' ELSE 'NO' END AS IssueDate_Mismatch, CASE WHEN ISNULL(ml.Total_Issued, 0) > 0 AND 
                                                    Core.[Date + Expiry] IS NOT NULL AND Core.[Date + Expiry] < DATEADD(DAY, - 7, CAST('2025-12-29' AS date)) /* Updated to current date*/ THEN 'YES' ELSE 'NO' END AS Early_Issue_Flag
                          FROM            (SELECT        *
                                                    FROM            (SELECT        j.*, ROW_NUMBER() OVER (PARTITION BY j.ORDERNUMBER, j.FG, j.ITEMNMBR
                                                                              ORDER BY j.Construct, j.[FG Desc], j.STSDESCR) AS rn_final
                                                    FROM            (SELECT        CAST(COALESCE (NULLIF (LTRIM(RTRIM(p_norm.ORDERNUMBER)), ''), NULLIF (LTRIM(RTRIM(m_norm.ORDERNUMBER)), ''), '') AS varchar(255)) AS ORDERNUMBER, 
                                                                                                        CAST(ISNULL(m_norm.Customer, '') AS varchar(255)) AS Construct, CAST(ISNULL(m_norm.FG, '') AS varchar(255)) AS FG, CAST(ISNULL(m_norm.[FG Desc], '') AS varchar(255)) AS [FG Desc], 
                                                                                                        CAST(ISNULL(p_norm.ITEMNMBR, '') AS varchar(255)) AS ITEMNMBR, CAST(ISNULL(item_desc.ItemDescription, '') AS varchar(255)) AS ItemDescription, CAST(ISNULL(item_desc.UOMSCHDL, 
                                                                                                        '') AS varchar(255)) AS UOMSCHDL, p_norm.STSDESCR, p_norm.DUEDATE, p_norm.[Expiry Dates], p_norm.[Date + Expiry], p_norm.MRPTYPE, p_norm.VendorItem, p_norm.INCLUDE_MRP, 
                                                                                                        p_norm.SITE, p_norm.PRIME_VNDR, p_norm.PURCHASING_LT, p_norm.PLANNING_LT, p_norm.ORDER_POINT_QTY, p_norm.SAFETY_STOCK, p_norm.CleanItem, p_norm.CleanOrder, 
                                                                                                        p_norm.Deductions AS Original_Deductions, p_norm.Expiry AS Original_Expiry, p_norm.[PO's] AS Original_POs, p_norm.Running_Balance AS Original_Running_Balance, 
                                                                                                        /* Safe numeric conversion for BEG_BAL (used in display)*/ CASE WHEN ISNUMERIC(LTRIM(RTRIM(p_norm.BEG_BAL))) = 1 THEN CAST(LTRIM(RTRIM(p_norm.BEG_BAL)) AS decimal(18, 5)) 
                                                                                                        ELSE 0 END AS BEG_BAL_Num, /* CleanDeductions for safe join*/ CASE WHEN ISNUMERIC(LTRIM(RTRIM(p_norm.Deductions))) = 1 THEN CAST(LTRIM(RTRIM(p_norm.Deductions)) 
                                                                                                        AS decimal(18, 5)) ELSE 0 END AS CleanDeductions
                                                                              FROM            (SELECT        p.*, UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), REPLACE(p.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')) 
                                                                                                                                  AS CleanOrder, LTRIM(RTRIM(p.ITEMNMBR)) AS CleanItem
                                                                                                        FROM            dbo.ETB_PAB_MO p
                                                                                                        WHERE        p.STSDESCR <> 'Partially Received' AND LTRIM(RTRIM(p.ITEMNMBR)) NOT LIKE '60.%' AND LTRIM(RTRIM(p.ITEMNMBR)) NOT LIKE '70.%') p_norm LEFT JOIN
                                                                                                            (SELECT        m.*, UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), REPLACE(m.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')) 
                                                                                                                                        AS CleanOrder, ROW_NUMBER() OVER (PARTITION BY UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), 
                                                                                                                                        REPLACE(m.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')), m.FG
                                                                                                              ORDER BY m.Customer, m.[FG Desc], m.ORDERNUMBER) AS rn_fg
                                                                              FROM            dbo.ETB_ActiveDemand_Union_FG_MO m) m_norm ON p_norm.CleanOrder = m_norm.CleanOrder AND (m_norm.rn_fg = 1 OR
                                                                              m_norm.rn_fg IS NULL) LEFT JOIN
                                                                                  (SELECT        [Item Number] AS ItemNumber, ITEMDESC AS ItemDescription, UOMSCHDL
                                                                                    FROM            dbo.Prosenthal_Vendor_Items
                                                                                    WHERE        Active = 'Yes') item_desc ON p_norm.ITEMNMBR = item_desc.ItemNumber) j) ranked
WHERE        ranked.rn_final = 1) Core LEFT JOIN
    (SELECT        CleanMO, ITEMNMBR, MRP_IssueDate, WCID_I, Total_Issued, Remaining_Required, Required_Qty, rn_qty, rn_any
      FROM            (SELECT        RTRIM(LTRIM(a.MANUFACTUREORDER_I)) AS CleanMO, RTRIM(LTRIM(a.ITEMNMBR)) AS ITEMNMBR, CAST(a.MRPISSUEDATE_I AS date) AS MRP_IssueDate, a.WCID_I, 
                                                          a.QTY_ISSUED_I + a.QTY_BACKFLUSHED_I AS Total_Issued, a.MRPAMOUNT_I - a.ATYALLOC - a.QTY_ISSUED_I - a.QTY_BACKFLUSHED_I AS Remaining_Required, a.MRPAMOUNT_I AS Required_Qty, 
                                                          ROW_NUMBER() OVER (PARTITION BY RTRIM(LTRIM(a.MANUFACTUREORDER_I)), RTRIM(LTRIM(a.ITEMNMBR)), a.MRPAMOUNT_I
                                ORDER BY CAST(a.MRPISSUEDATE_I AS date) DESC) AS rn_qty, ROW_NUMBER() OVER (PARTITION BY RTRIM(LTRIM(a.MANUFACTUREORDER_I)), RTRIM(LTRIM(a.ITEMNMBR))
      ORDER BY CASE WHEN (a.QTY_ISSUED_I + a.QTY_BACKFLUSHED_I) > 0 THEN 1 ELSE 2 END, ABS(a.MRPAMOUNT_I) DESC, CAST(a.MRPISSUEDATE_I AS date) DESC) AS rn_any
FROM            dbo.PK010033 AS a WITH (NOLOCK) LEFT OUTER JOIN
                         dbo.IV00101 AS b WITH (NOLOCK) ON a.ITEMNMBR = b.ITEMNMBR
WHERE        EXISTS
                             (SELECT        1
                               FROM            dbo.WO010032 AS w WITH (NOLOCK)
                               WHERE        w.MANUFACTUREORDERST_I IN (2, 3) AND RTRIM(LTRIM(w.MANUFACTUREORDER_I)) = RTRIM(LTRIM(a.MANUFACTUREORDER_I)))) ranked_ledger) ml ON Core.CleanOrder = ml.CleanMO AND 
Core.CleanItem = ml.ITEMNMBR AND ((Core.CleanDeductions = ml.Required_Qty AND ml.rn_qty = 1) OR
ml.rn_any = 1)) Final
ORDER BY Final.[Date + Expiry], Final.ORDERNUMBER, Final.ITEMNMBR;
