WITH RawData AS (
    SELECT 
        Core.ITEMNMBR, 
        Core.ItemDescription, 
        Core.UOMSCHDL AS UOM, 
        Core.ORDERNUMBER, 
        Core.Construct, 
        Core.DUEDATE, 
        Core.[Expiry Dates], 
        Core.[Date + Expiry], 
        CAST(Core.BEG_BAL_Num AS VARCHAR(50)) AS BEG_BAL, 
        Core.Original_Deductions AS Deductions, 
        Core.Original_Expiry AS Expiry, 
        Core.Original_POs AS [PO's], 
        Core.Original_Running_Balance AS Running_Balance, 
        ISNULL(ml.MRP_IssueDate, '') AS MRP_IssueDate, 
        ISNULL(ml.WCID_I, '') AS WCID_From_MO, 
        ISNULL(ml.Total_Issued, 0) AS Issued, 
        /* Determine Demand: Use Remaining from MO if it exists, otherwise use Original Deduction */
        ISNULL(ml.Remaining_Required, Core.CleanDeductions) AS Demand_Qty,
        inv.Total_QTY_Available AS Inventory_Qty_Available,
        Core.VendorItem, 
        Core.PRIME_VNDR, 
        Core.PURCHASING_LT, 
        Core.PLANNING_LT, 
        Core.ORDER_POINT_QTY, 
        Core.SAFETY_STOCK, 
        Core.FG, 
        Core.[FG Desc], 
        Core.STSDESCR, 
        Core.MRPTYPE
    FROM (
        SELECT *
        FROM (
            SELECT joined.*, 
                   ROW_NUMBER() OVER (PARTITION BY ORDERNUMBER, FG, ITEMNMBR ORDER BY Construct, [FG Desc], STSDESCR) AS rn_final
            FROM (
                SELECT 
                    CAST(COALESCE(NULLIF(LTRIM(RTRIM(p_norm.ORDERNUMBER)), ''), NULLIF(LTRIM(RTRIM(m_norm.ORDERNUMBER)), ''), '') AS varchar(255)) AS ORDERNUMBER, 
                    CAST(ISNULL(m_norm.Customer, '') AS varchar(255)) AS Construct, 
                    CAST(ISNULL(m_norm.FG, '') AS varchar(255)) AS FG, 
                    CAST(ISNULL(m_norm.[FG Desc], '') AS varchar(255)) AS [FG Desc], 
                    CAST(ISNULL(p_norm.ITEMNMBR, '') AS varchar(255)) AS ITEMNMBR, 
                    CAST(ISNULL(item_desc.ItemDescription, '') AS varchar(500)) AS ItemDescription, 
                    CAST(ISNULL(item_desc.UOMSCHDL, '') AS varchar(50)) AS UOMSCHDL, 
                    p_norm.STSDESCR, p_norm.DUEDATE, p_norm.[Expiry Dates], p_norm.[Date + Expiry], p_norm.MRPTYPE, 
                    p_norm.VendorItem, p_norm.PRIME_VNDR, p_norm.PURCHASING_LT, p_norm.PLANNING_LT, 
                    p_norm.ORDER_POINT_QTY, p_norm.SAFETY_STOCK, 
                    p_norm.Deductions AS Original_Deductions, p_norm.Expiry AS Original_Expiry, 
                    p_norm.[PO's] AS Original_POs, p_norm.Running_Balance AS Original_Running_Balance, 
                    CASE WHEN ISNUMERIC(LTRIM(RTRIM(p_norm.BEG_BAL))) = 1 THEN CAST(LTRIM(RTRIM(p_norm.BEG_BAL)) AS decimal(18, 6)) ELSE 0 END AS BEG_BAL_Num, 
                    p_norm.CleanOrder, p_norm.CleanItem, p_norm.CleanDeductions
                FROM (
                    SELECT p.*, 
                           UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), REPLACE(p.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')) AS CleanOrder, 
                           LTRIM(RTRIM(p.ITEMNMBR)) AS CleanItem, 
                           CASE WHEN ISNUMERIC(LTRIM(RTRIM(p.Deductions))) = 1 THEN CAST(LTRIM(RTRIM(p.Deductions)) AS decimal(18, 5)) ELSE 0 END AS CleanDeductions
                    FROM dbo.ETB_PAB_MO p
                    WHERE p.STSDESCR <> 'Partially Received' 
                      AND LTRIM(RTRIM(p.ITEMNMBR)) NOT LIKE '60.%' 
                      AND LTRIM(RTRIM(p.ITEMNMBR)) NOT LIKE '70.%'
                ) p_norm 
                LEFT JOIN (
                    SELECT m.*, 
                           UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), REPLACE(m.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')) AS CleanOrder, 
                           ROW_NUMBER() OVER (PARTITION BY UPPER(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(varchar(255), REPLACE(m.ORDERNUMBER, 'MO', '')))), '-', ''), ' ', ''), '/', ''), '.', ''), '#', '')) ORDER BY m.Customer, m.[FG Desc], m.ORDERNUMBER) AS rn_fg
                    FROM dbo.ETB_ActiveDemand_Union_FG_MO m
                ) m_norm ON p_norm.CleanOrder = m_norm.CleanOrder AND m_norm.rn_fg = 1 
                LEFT JOIN (
                    SELECT [Item Number] AS ItemNumber, ITEMDESC AS ItemDescription, UOMSCHDL
                    FROM dbo.Prosenthal_Vendor_Items
                    WHERE Active = 'Yes'
                ) item_desc ON p_norm.ITEMNMBR = item_desc.ItemNumber
            ) joined
        ) ranked
        WHERE rn_final = 1
    ) Core 
    LEFT JOIN (
        SELECT 
            RTRIM(LTRIM(a.MANUFACTUREORDER_I)) AS CleanMO, 
            RTRIM(LTRIM(a.ITEMNMBR)) AS ITEMNMBR, 
            CAST(a.MRPISSUEDATE_I AS date) AS MRP_IssueDate, 
            a.WCID_I, 
            a.QTY_ISSUED_I + a.QTY_BACKFLUSHED_I AS Total_Issued, 
            a.MRPAMOUNT_I - a.ATYALLOC - a.QTY_ISSUED_I - a.QTY_BACKFLUSHED_I AS Remaining_Required, 
            a.MRPAMOUNT_I AS Required_Qty, 
            ROW_NUMBER() OVER (PARTITION BY RTRIM(LTRIM(a.MANUFACTUREORDER_I)), RTRIM(LTRIM(a.ITEMNMBR)), a.MRPAMOUNT_I ORDER BY CAST(a.MRPISSUEDATE_I AS date) DESC) AS rn_qty, 
            ROW_NUMBER() OVER (PARTITION BY RTRIM(LTRIM(a.MANUFACTUREORDER_I)), RTRIM(LTRIM(a.ITEMNMBR)) ORDER BY CASE WHEN (a.QTY_ISSUED_I + a.QTY_BACKFLUSHED_I) > 0 THEN 1 ELSE 2 END, ABS(a.MRPAMOUNT_I) DESC, CAST(a.MRPISSUEDATE_I AS date) DESC) AS rn_any
        FROM dbo.PK010033 a WITH (NOLOCK) 
        WHERE EXISTS (
            SELECT 1 FROM dbo.WO010032 w WITH (NOLOCK)
            WHERE w.MANUFACTUREORDERST_I IN (2, 3) 
              AND RTRIM(LTRIM(w.MANUFACTUREORDER_I)) = RTRIM(LTRIM(a.MANUFACTUREORDER_I))
        )
    ) ml ON Core.CleanOrder = ml.CleanMO 
        AND Core.CleanItem = ml.ITEMNMBR 
        AND ((Core.CleanDeductions = ml.Required_Qty AND ml.rn_qty = 1) OR ml.rn_any = 1)
    LEFT JOIN (
        /* Inventory logic: Only Slippage or Investigate (0-45 Days) */
        SELECT 
            Item_Number, SITE, SUM(QTY_Available) AS Total_QTY_Available
        FROM dbo.Prosenthal_INV_BIN_QTY_wQTYTYPE
        WHERE SITE LIKE 'WC-W%' AND DATEDIFF(DAY, DATERECD, GETDATE()) <= 45 
        GROUP BY Item_Number, SITE
    ) inv ON Core.ITEMNMBR = inv.Item_Number AND ml.WCID_I = inv.SITE
),
ProcessedData AS (
    SELECT 
        *,
        /* RULE 1: Stale + Unissued Suppression (7 Day Grace) */
        CASE WHEN DUEDATE <= DATEADD(DAY, -7, CAST(GETDATE() AS date)) AND Issued = 0 THEN 1 ELSE 0 END AS Suppress_Stale,
        
        /* RULE 2: Fence Inventory Suppression (7 Day Forward Fence + Full Coverage) */
        CASE WHEN DUEDATE <= DATEADD(DAY, 7, CAST(GETDATE() AS date)) AND Inventory_Qty_Available >= Demand_Qty THEN 1 ELSE 0 END AS Suppress_Fence,
        
        /* RULE 4: Net Demand Calculation (Partial Coverage) */
        CASE 
            WHEN Inventory_Qty_Available > 0 AND Inventory_Qty_Available < Demand_Qty THEN Demand_Qty - Inventory_Qty_Available 
            ELSE Demand_Qty 
        END AS Net_Demand
    FROM RawData
)
SELECT 
    ITEMNMBR, ItemDescription, UOM, ORDERNUMBER, Construct, DUEDATE, [Expiry Dates], [Date + Expiry], BEG_BAL, 
    Deductions, Expiry, [PO's], Running_Balance, MRP_IssueDate, WCID_From_MO, Issued, 
    Demand_Qty AS Original_Required,
    Net_Demand,
    Inventory_Qty_Available,
    /* Operational Notes for Suppressions */
    CASE 
        WHEN Suppress_Stale = 1 THEN 'SUPPRESSED: Stale & Unissued'
        WHEN Suppress_Fence = 1 THEN 'SUPPRESSED: Full Coverage in Fence'
        WHEN Inventory_Qty_Available > 0 AND Inventory_Qty_Available < Demand_Qty THEN 'PARTIAL: Demand Netted'
        ELSE 'VALID DEMAND'
    END AS Suppression_Status
FROM ProcessedData
WHERE Suppress_Stale = 0  -- Precedence 1: Remove abandoned intent immediately
  AND Suppress_Fence = 0; -- Precedence 2: Remove fully covered short-term demand
