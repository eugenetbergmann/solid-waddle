-- WFQ Supply Allocation View
-- Builds on ETB_WC_INV_Unified to add pipeline supply and extended balance logic

WITH Demand_Ledger AS (
    -- Reference the combined view output
    SELECT
        ITEMNMBR,
        ItemDescription,
        UOM,
        ORDERNUMBER,
        Construct,
        DUEDATE,
        [Expiry Dates],
        [Date + Expiry],
        BEG_BAL,
        Deductions,
        Expiry,
        [PO's],
        Running_Balance,
        MRP_IssueDate,
        WCID_From_MO,
        Issued,
        Original_Required,
        Net_Demand,
        Inventory_Qty_Available,
        Suppression_Status,
        VendorItem,
        PRIME_VNDR,
        PURCHASING_LT,
        PLANNING_LT,
        ORDER_POINT_QTY,
        SAFETY_STOCK,
        FG,
        [FG Desc],
        STSDESCR,
        MRPTYPE,
        Unified_Value
    FROM dbo.ETB_WC_INV_Unified
),

Demand_Seq AS (
    -- Sequence demand rows per item by due date for stockout detection
    SELECT 
        *,
        ROW_NUMBER() OVER (PARTITION BY ITEMNMBR ORDER BY DUEDATE) AS Demand_Seq
    FROM Demand_Ledger
),

Stockout_Detection AS (
    -- Detect first stockout per item (where Running_Balance <= 0)
    -- This establishes the threshold for when WFQ supply begins to apply
    SELECT 
        *,
        MIN(CASE WHEN CAST(Running_Balance AS decimal(18, 6)) <= 0 THEN Demand_Seq END) 
            OVER (PARTITION BY ITEMNMBR) AS Stockout_Seq
    FROM Demand_Seq
),

WFQ_Supply AS (
    -- Aggregate WFQ pipeline supply by item, site, and estimated release date
    -- Only include ITEM_LEVEL view with positive quantity available for supply
    SELECT 
        ITEM_Number AS ITEMNMBR,
        SITE,
        SUM(QTY_ON_HAND) AS WFQ_Qty,
        Estimated_Release_Date
    FROM dbo.ETB_WFQ_PIPE
    WHERE View_Level = 'ITEM_LEVEL' 
      AND QTY_ON_HAND > 0
    GROUP BY ITEM_Number, SITE, Estimated_Release_Date
),

WFQ_Allocated AS (
    -- Calculate cumulative WFQ influx per demand row
    -- WFQ supply only applies:
    --   1. After stockout (Demand_Seq >= Stockout_Seq)
    --   2. When Estimated_Release_Date <= DUEDATE (supply available in time)
    SELECT 
        d.ITEMNMBR,
        d.Demand_Seq,
        d.DUEDATE,
        d.Running_Balance AS Ledger_Base_Balance,
        d.Stockout_Seq,
        SUM(CASE 
                WHEN w.Estimated_Release_Date <= d.DUEDATE 
                     AND d.Demand_Seq >= d.Stockout_Seq THEN w.WFQ_Qty
                ELSE 0
            END) AS Ledger_WFQ_Influx
    FROM Stockout_Detection d
    LEFT JOIN WFQ_Supply w
           ON d.ITEMNMBR = w.ITEMNMBR
    GROUP BY d.ITEMNMBR, d.Demand_Seq, d.DUEDATE, d.Running_Balance, d.Stockout_Seq
),

Extended_Ledger AS (
    -- Final projection: base ledger + additive WFQ overlay columns
    SELECT 
        d.*,
        ISNULL(w.Ledger_WFQ_Influx, 0) AS Ledger_WFQ_Influx,
        CAST(d.Running_Balance AS decimal(18, 6)) + ISNULL(w.Ledger_WFQ_Influx, 0) AS Ledger_Extended_Balance,
        CASE 
            WHEN w.Ledger_WFQ_Influx IS NULL OR w.Ledger_WFQ_Influx <= 0 THEN 'LEDGER_ONLY'
            WHEN CAST(d.Running_Balance AS decimal(18, 6)) + ISNULL(w.Ledger_WFQ_Influx, 0) > 0 
                 AND CAST(d.Running_Balance AS decimal(18, 6)) <= 0 THEN 'WFQ_RESCUED'
            WHEN CAST(d.Running_Balance AS decimal(18, 6)) + ISNULL(w.Ledger_WFQ_Influx, 0) > 0 THEN 'WFQ_ENHANCED'
            ELSE 'WFQ_INSUFFICIENT'
        END AS WFQ_Extended_Status
    FROM Stockout_Detection d
    LEFT JOIN WFQ_Allocated w
           ON d.ITEMNMBR = w.ITEMNMBR 
          AND d.Demand_Seq = w.Demand_Seq
)

-- Final output: all upstream columns in original order + additive overlay columns
SELECT 
    ITEMNMBR,
    ItemDescription,
    UOM,
    ORDERNUMBER,
    Construct,
    DUEDATE,
    [Expiry Dates],
    [Date + Expiry],
    BEG_BAL,
    Deductions,
    Expiry,
    [PO's],
    Running_Balance,
    MRP_IssueDate,
    WCID_From_MO,
    Issued,
    Original_Required,
    Net_Demand,
    Inventory_Qty_Available,
    Suppression_Status,
    VendorItem,
    PRIME_VNDR,
    PURCHASING_LT,
    PLANNING_LT,
    ORDER_POINT_QTY,
    SAFETY_STOCK,
    FG,
    [FG Desc],
    STSDESCR,
    MRPTYPE,
    Unified_Value,
    -- Additive overlay columns (PAB Extension v3.2)
    Ledger_WFQ_Influx,
    Ledger_Extended_Balance,
    WFQ_Extended_Status
FROM Extended_Ledger;
